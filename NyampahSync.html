
<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nyampah Sync — Master ↔ Log (HTML)</title>
<style>
  :root{--bg:#0b1220;--card:#121a2a;--muted:#9bb0d1;--accent:#7ee787;--danger:#ff6b6b;}
  html,body{margin:0;padding:0;background:var(--bg);color:#e6edf3;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
  h1,h2{margin:8px 0 6px}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid #23304a;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 1px 12px rgba(0,0,0,.25)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type=file],select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3a59;background:#0f1726;color:#e6edf3}
  button{background:#1f2a44;border-color:#33446a;cursor:pointer}
  button.primary{background:#1a3b2b;border-color:#2a5c40;color:#d6ffe6}
  button.warn{background:#3c1a1a;border-color:#6a3333;color:#ffd6d6}
  .grid{width:100%;border-collapse:collapse;font-size:12.5px}
  .grid th,.grid td{border:1px solid #23304a;padding:6px 8px}
  .grid th{background:#16233b;color:#cfe2f3;position:sticky;top:0}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #2a3a59;color:#9bb0d1}
  .ok{color:var(--accent)}
  .err{color:var(--danger)}
  .tip{font-size:12px;color:#9bb0d1}
  .footer{margin-top:10px;color:#9bb0d1;font-size:12px}
  .small{font-size:12px;color:#9bb0d1}
  .sep{height:1px;background:#22304b;margin:12px 0}
  .title{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .badge{background:#12243a;border:1px solid #254a75;color:#9fd1ff;padding:4px 10px;border-radius:999px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <h1>Nyampah Sync <span class="small">— Master ↔ Log (HTML)</span></h1>
    <span class="badge">Client‑side • No server</span>
  </div>
  <div class="card">
    <h2>1) Unggah data</h2>
    <div class="row">
      <div class="col">
        <label>File <b>Master</b> (.xlsx / .csv)</label>
        <input type="file" id="fileMaster" accept=".xlsx,.xls,.csv">
      </div>
      <div class="col">
        <label>File <b>Log Aktivitas</b> (.xlsx / .csv)</label>
        <input type="file" id="fileLog" accept=".xlsx,.xls,.csv">
      </div>
    </div>
    <div class="sep"></div>
    <div class="row">
      <div class="col"><label>Peta kolom <b>Master</b> — NIM</label><select id="mNIM"></select></div>
      <div class="col"><label>Peta kolom <b>Master</b> — NIK</label><select id="mNIK"></select></div>
      <div class="col"><label>Peta kolom <b>Master</b> — Email</label><select id="mEmail"></select></div>
      <div class="col"><label>Peta kolom <b>Master</b> — No. WA</label><select id="mWA"></select></div>
      <div class="col"><label>Peta kolom <b>Master</b> — Nama</label><select id="mNama"></select></div>
      <div class="col"><label>Peta kolom <b>Master</b> — Tgl Lahir</label><select id="mTTL"></select></div>
      <div class="col"><label>Peta kolom <b>Master</b> — Alamat</label><select id="mAlamat"></select></div>
      <div class="col"><label>Peta kolom <b>Master</b> — STATUS DIKTI</label><select id="mStatus"></select></div>
      <div class="col"><label>Peta kolom <b>Master</b> — Total Pembayaran</label><select id="mBayar"></select></div>
    </div>
    <div class="sep"></div>
    <div class="row">
      <div class="col"><label>Peta kolom <b>Log</b> — NIM</label><select id="lNIM"></select></div>
      <div class="col"><label>Peta kolom <b>Log</b> — NIK</label><select id="lNIK"></select></div>
      <div class="col"><label>Peta kolom <b>Log</b> — Email</label><select id="lEmail"></select></div>
      <div class="col"><label>Peta kolom <b>Log</b> — No. WA</label><select id="lWA"></select></div>
      <div class="col"><label>Peta kolom <b>Log</b> — Nama</label><select id="lNama"></select></div>
      <div class="col"><label>Peta kolom <b>Log</b> — Tgl Lahir</label><select id="lTTL"></select></div>
      <div class="col"><label>Peta kolom <b>Log</b> — Alamat</label><select id="lAlamat"></select></div>
      <div class="col"><label>Peta kolom <b>Log</b> — STATUS DIKTI</label><select id="lStatus"></select></div>
      <div class="col"><label>Peta kolom <b>Log</b> — Total Pembayaran</label><select id="lBayar"></select></div>
    </div>
    <div class="sep"></div>
    <div class="row">
      <div class="col"><button class="primary" id="btnPreview">Preview sinkron (20 baris)</button></div>
      <div class="col"><button id="btnSyncView">Download SYNC_VIEW.xlsx</button></div>
      <div class="col"><button class="warn" id="btnMasterUpdate">Download Master_Updated.xlsx (isi yang kosong)</button></div>
    </div>
    <div class="footer">Kunci prioritas: <span class="pill">NIM</span> → <span class="pill">NIK</span> → <span class="pill">Email_norm</span> → <span class="pill">WA_norm</span>. Normalisasi otomatis.</div>
  </div>

  <div class="card">
    <h2>2) Preview hasil</h2>
    <div id="preview" class="tip">Belum ada data. Unggah file & mapping kolom dulu, lalu klik <b>Preview sinkron</b>.</div>
  </div>

  <div class="footer">© Nyampah Bersama • HTML alat bantu sinkron data — bekerja sepenuhnya di browser kamu.</div>
</div>

<!-- SheetJS & FileSaver (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
// Helpers
const byId = id => document.getElementById(id);
let master = [], log = [], mHeaders=[], lHeaders=[];

function optionize(select, headers){
  select.innerHTML = '<option value="">— pilih —</option>' + headers.map(h=>`<option>${h}</option>`).join('');
}

function loadFile(file, cb){
  const reader = new FileReader();
  reader.onload = e => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, {type:'array'});
    // ambil sheet pertama
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {defval:""});
    cb(json);
  };
  reader.readAsArrayBuffer(file);
}

function normEmail(v){
  return String(v||'').trim().toLowerCase();
}
function onlyDigits(s){
  return String(s||'').replace(/[^\d+]/g,'');
}
function normWA(v){
  let x = onlyDigits(v).trim();
  if (x.startsWith('+62')) return '0' + x.slice(3);
  if (x.startsWith('62')) return '0' + x.slice(2);
  if (x.startsWith('8')) return '0' + x;
  return x;
}
function makeKey(row, map){
  const NIM = row[map.NIM]||'';
  const NIK = row[map.NIK]||'';
  const EM  = normEmail(row[map.Email]);
  const WA  = normWA(row[map.WA]);
  if (NIM) return 'NIM:'+NIM;
  if (NIK) return 'NIK:'+NIK;
  if (EM)  return 'EM:'+EM;
  if (WA)  return 'WA:'+WA;
  return '';
}

function mapFromUI(prefix){
  return {
    NIM:   byId(prefix+'NIM').value,
    NIK:   byId(prefix+'NIK').value,
    Email: byId(prefix+'Email').value,
    WA:    byId(prefix+'WA').value,
    Nama:  byId(prefix+'Nama').value,
    TTL:   byId(prefix+'TTL').value,
    Alamat:byId(prefix+'Alamat').value,
    Status:byId(prefix+'Status').value,
    Bayar: byId(prefix+'Bayar').value,
  };
}

function indexByKey(arr, map){
  const m = new Map();
  for (const row of arr){
    const key = makeKey(row, map);
    if (!key) continue;
    m.set(key, row); // terakhir menang (anggap yang terbaru)
  }
  return m;
}

function fillOnly(masterRow, mMap, logRow, lMap){
  const out = {...masterRow};
  // kolom target
  const targets = [
    ['Alamat',  mMap.Alamat,  lMap.Alamat],
    ['NoWA',    mMap.WA,      lMap.WA],
    ['TTL',     mMap.TTL,     lMap.TTL],
    ['Status',  mMap.Status,  lMap.Status],
    ['Bayar',   mMap.Bayar,   lMap.Bayar],
  ];
  for (const [label, mCol, lCol] of targets){
    if (!mCol || !lCol) continue;
    const cur = out[mCol];
    if (String(cur||'').trim()!=='') continue; // hanya isi kalau kosong
    out[mCol] = logRow[lCol]||cur;
  }
  return out;
}

function buildSyncView(masterRow, mMap, logRow, lMap){
  // final = pakai master jika ada, kalau kosong ambil dari log
  function finalOf(mCol, lCol, normalizeWA=false){
    const mVal = masterRow[mCol] ?? '';
    if (String(mVal||'').trim()!=='') return normalizeWA ? normWA(mVal) : mVal;
    const lVal = logRow ? (logRow[lCol] ?? '') : '';
    return normalizeWA ? normWA(lVal) : lVal;
  }
  return {
    NIM: masterRow[mMap.NIM] ?? '',
    NIK: masterRow[mMap.NIK] ?? '',
    Email: masterRow[mMap.Email] ?? '',
    WA_final: finalOf(mMap.WA, lMap.WA, true),
    Nama: masterRow[mMap.Nama] ?? '',
    TTL_final: finalOf(mMap.TTL, lMap.TTL, false),
    Alamat_final: finalOf(mMap.Alamat, lMap.Alamat, false),
    STATUS_final: finalOf(mMap.Status, lMap.Status, false),
    Pembayaran_final: finalOf(mMap.Bayar, lMap.Bayar, false),
    KEY: makeKey(masterRow, mMap),
  };
}

function renderPreview(rows){
  const wrap = byId('preview');
  if (!rows.length){ wrap.innerHTML = '<div class="tip">Tidak ada data.</div>'; return; }
  const headers = Object.keys(rows[0]);
  let html = '<div class="small">Menampilkan 20 baris pertama:</div><div style="max-height:420px;overflow:auto;margin-top:8px"><table class="grid"><thead><tr>';
  for (const h of headers) html+= `<th>${h}</th>`;
  html += '</tr></thead><tbody>';
  for (const r of rows.slice(0,20)){
    html += '<tr>';
    for (const h of headers) html+= `<td>${String(r[h]??'')}</td>`;
    html += '</tr>';
  }
  html += '</tbody></table></div>';
  wrap.innerHTML = html;
}

function toSheetAndDownload(json, filename){
  const ws = XLSX.utils.json_to_sheet(json);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Data');
  const out = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  saveAs(new Blob([out], {type:"application/octet-stream"}), filename);
}

// Event wires
byId('fileMaster').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f)return;
  loadFile(f, rows=>{
    master = rows;
    mHeaders = [...new Set(Object.keys(rows[0]||{}))];
    ['mNIM','mNIK','mEmail','mWA','mNama','mTTL','mAlamat','mStatus','mBayar'].forEach(id=>optionize(byId(id), mHeaders));
  });
});
byId('fileLog').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f)return;
  loadFile(f, rows=>{
    log = rows;
    lHeaders = [...new Set(Object.keys(rows[0]||{}))];
    ['lNIM','lNIK','lEmail','lWA','lNama','lTTL','lAlamat','lStatus','lBayar'].forEach(id=>optionize(byId(id), lHeaders));
  });
});

byId('btnPreview').addEventListener('click', ()=>{
  if (!master.length){ alert('Unggah file Master dulu.'); return; }
  const mMap = mapFromUI('m'); const lMap = mapFromUI('l');
  const lIndex = indexByKey(log, lMap);
  const rows = [];
  for (const mr of master){
    const key = makeKey(mr, mMap);
    const lr = lIndex.get(key);
    rows.push(buildSyncView(mr, mMap, lr, lMap));
  }
  renderPreview(rows);
});

byId('btnSyncView').addEventListener('click', ()=>{
  if (!master.length){ alert('Unggah file Master dulu.'); return; }
  const mMap = mapFromUI('m'); const lMap = mapFromUI('l');
  const lIndex = indexByKey(log, lMap);
  const out = master.map(mr => buildSyncView(mr, mMap, lIndex.get(makeKey(mr, mMap)), lMap));
  toSheetAndDownload(out, 'SYNC_VIEW.xlsx');
});

byId('btnMasterUpdate').addEventListener('click', ()=>{
  if (!master.length){ alert('Unggah file Master dulu.'); return; }
  const mMap = mapFromUI('m'); const lMap = mapFromUI('l');
  const lIndex = indexByKey(log, lMap);
  const updated = master.map(mr => {
    const key = makeKey(mr, mMap);
    const lr = lIndex.get(key);
    return lr ? fillOnly(mr, mMap, lr, lMap) : mr;
  });
  toSheetAndDownload(updated, 'Master_Updated.xlsx');
});
</script>
</body>
</html>
