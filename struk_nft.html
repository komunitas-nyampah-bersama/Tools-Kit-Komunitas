<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Struk Pembayaran NFT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --accent: #e74c3c;
            --success: #27ae60;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --border: #dee2e6;
            --info-bg: #d1ecf1;
            --receipt-bg: #ffffff;
            --company-color: #2c3e50;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: rgba(255, 255, 255, 0.97);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
            position: relative;
        }
        
        .logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 48px;
        }
        
        h1 {
            color: var(--secondary);
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .intro {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--gray);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 992px) {
            .form-container {
                grid-template-columns: 1fr;
            }
        }
        
        .form-section {
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
        }
        
        .form-section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-section h2 i {
            background: var(--primary);
            color: white;
            width: 36px;
            height: 36px;
            borderRadius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--secondary);
        }
        
        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 16px;
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(52, 152, 219, 0.4);
        }
        
        button.success {
            background: linear-gradient(to right, var(--success), #219653);
        }
        
        button.secondary {
            background: linear-gradient(to right, var(--secondary), #34495e);
        }
        
        button.accent {
            background: linear-gradient(to right, var(--accent), #c0392b);
        }
        
        #paymentDetails {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(to right, #e8f5e9, #c8e6c9);
            border-radius: 10px;
            border: 2px dashed #4caf50;
            display: none;
        }
        
        .info-text {
            font-size: 0.9em;
            color: var(--gray);
            margin-top: 5px;
            font-style: italic;
        }
        
        /* Receipt Styles */
        .receipt-container {
            display: none;
            margin-top: 40px;
            text-align: center;
        }
        
        .receipt {
            background: var(--receipt-bg);
            border: 2px solid #ccc;
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            text-align: left;
        }
        
        .receipt::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><path fill="none" stroke="%233498db" stroke-width="1" opacity="0.1" d="M20,20 Q40,5 60,20 T100,20 M20,50 Q40,35 60,50 T100,50 M20,80 Q40,65 60,80 T100,80 M20,110 Q40,95 60,110 T100,110 M20,140 Q40,125 60,140 T100,140 M20,170 Q40,155 60,170 T100,170 M140,20 Q160,5 180,20 T200,20 M140,50 Q160,35 180,50 T200,50 M140,80 Q160,65 180,80 T200,80 M140,110 Q160,95 180,110 T200,110 M140,140 Q160,125 180,140 T200,140 M140,170 Q160,155 180,170 T200,170"/></svg>');
            background-repeat: repeat;
            opacity: 0.15;
            z-index: 0;
        }
        
        /* Kop Surat Instansi */
        .company-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        
        .company-name {
            font-size: 28px;
            font-weight: 800;
            color: var(--company-color);
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .company-tagline {
            font-size: 16px;
            color: var(--gray);
            margin-bottom: 10px;
        }
        
        .company-contact {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 14px;
            color: var(--gray);
            margin-top: 10px;
        }
        
        .receipt-title {
            font-size: 24px;
            color: var(--secondary);
            font-weight: 800;
            letter-spacing: 1px;
            margin-bottom: 5px;
            text-align: center;
            margin-top: 20px;
        }
        
        .receipt-subtitle {
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 25px;
            text-align: center;
        }
        
        .receipt-info {
            margin: 20px 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .receipt-info div {
            margin-bottom: 15px;
        }
        
        .receipt-label {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .receipt-value {
            font-size: 16px;
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 15px;
        }
        
        .items-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .items-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .items-table tr:nth-child(even) {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .total-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid var(--border);
            text-align: right;
            font-size: 18px;
        }
        
        .total-amount {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent);
            margin-top: 10px;
        }
        
        .nft-badge {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin-top: 15px;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            color: var(--gray);
            font-size: 0.9rem;
            border-top: 1px solid var(--border);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--secondary);
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.5s, fadeOut 0.5s 2.5s forwards;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .payment-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .payment-option {
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-option.selected {
            border-color: var(--primary);
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .payment-option i {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .qr-container {
            margin: 20px auto;
            text-align: center;
            padding: 15px;
        }
        
        .qr-container canvas {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .tax-info {
            background: #f1f8e9;
            border-left: 4px solid var(--success);
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 20px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .receipt {
                padding: 20px;
            }
            
            .company-name {
                font-size: 24px;
            }
            
            .receipt-title {
                font-size: 22px;
            }
            
            .receipt-info {
                grid-template-columns: 1fr;
            }
            
            .payment-options {
                grid-template-columns: 1fr 1fr;
            }
            
            .receipt-value {
                font-size: 15px;
            }
        }
        
        .transaction-id {
            background: #e0f7fa;
            padding: 10px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 16px;
            text-align: center;
            word-break: break-all;
        }
        
        .action-buttons {
            margin-top: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        
        .action-buttons button {
            width: auto;
            min-width: 200px;
            padding: 12px 20px;
        }
        
        .company-logo {
            width: 100px;
            margin: 0 auto 15px;
        }
        
        .company-logo img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }
        
        .company-address {
            margin-top: 10px;
            font-size: 14px;
            color: var(--gray);
        }
        
        .form-company {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed var(--border);
        }
        
        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <h1>Sistem Struk Pembayaran NFT</h1>
            <p class="intro">Bayar tagihan Anda dan dapatkan bukti pembayaran digital sebagai NFT yang terverifikasi di blockchain</p>
        </header>
        
        <div class="form-container">
            <section class="form-section">
                <h2><i class="fas fa-user"></i> Data Pelanggan</h2>
                
                <div class="form-group">
                    <label for="namaPelanggan">Nama Pelanggan:</label>
                    <input type="text" id="namaPelanggan" placeholder="Contoh: Budi Santoso">
                </div>
                
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="Contoh: nama@email.com">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="noPelanggan">No. Pelanggan:</label>
                        <input type="text" id="noPelanggan" placeholder="Contoh: PLG-123456">
                    </div>
                    
                    <div class="form-group">
                        <label for="noTelp">No. Telepon:</label>
                        <input type="text" id="noTelp" placeholder="Contoh: 081234567890">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="alamat">Alamat Lengkap:</label>
                    <textarea id="alamat" rows="3" placeholder="Contoh: Jl. Merdeka No. 123"></textarea>
                </div>
            </section>
            
            <section class="form-section">
                <h2><i class="fas fa-receipt"></i> Detail Tagihan</h2>
                
                <div class="form-group">
                    <label for="jenisTagihan">Jenis Tagihan:</label>
                    <select id="jenisTagihan">
                        <option value="listrik">Listrik</option>
                        <option value="air">Air</option>
                        <option value="telepon">Telepon & Internet</option>
                        <option value="kartuKredit">Kartu Kredit</option>
                        <option value="pajak">Pajak</option>
                        <option value="lainnya">Lainnya</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="periodeAwal">Periode Awal:</label>
                        <input type="date" id="periodeAwal">
                    </div>
                    
                    <div class="form-group">
                        <label for="periodeAkhir">Periode Akhir:</label>
                        <input type="date" id="periodeAkhir">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="metodePembayaran">Metode Pembayaran:</label>
                    <div class="payment-options">
                        <div class="payment-option" onclick="selectPaymentMethod('bank')">
                            <i class="fas fa-university"></i>
                            <div>Transfer Bank</div>
                        </div>
                        <div class="payment-option" onclick="selectPaymentMethod('ewallet')">
                            <i class="fas fa-wallet"></i>
                            <div>E-Wallet</div>
                        </div>
                        <div class="payment-option" onclick="selectPaymentMethod('kartu')">
                            <i class="fas fa-credit-card"></i>
                            <div>Kartu Debit</div>
                        </div>
                        <div class="payment-option" onclick="selectPaymentMethod('cash')">
                            <i class="fas fa-money-bill-wave"></i>
                            <div>Tunai</div>
                        </div>
                    </div>
                    <input type="hidden" id="metodePembayaran" value="">
                </div>
                
                <div class="form-company">
                    <h3><i class="fas fa-building"></i> Informasi Instansi/UMKM</h3>
                    
                    <div class="form-group">
                        <label for="namaInstansi">Nama Instansi/UMKM:</label>
                        <input type="text" id="namaInstansi" placeholder="Contoh: PT. Energi Sejahtera">
                    </div>
                    
                    <div class="form-group">
                        <label for="alamatInstansi">Alamat Instansi:</label>
                        <textarea id="alamatInstansi" rows="2" placeholder="Contoh: Jl. Industri No. 45"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="telpInstansi">Telepon:</label>
                            <input type="text" id="telpInstansi" placeholder="Contoh: (021) 123456">
                        </div>
                        
                        <div class="form-group">
                            <label for="emailInstansi">Email:</label>
                            <input type="email" id="emailInstansi" placeholder="Contoh: info@instansi.com">
                        </div>
                    </div>
                </div>
                
                <div class="tax-info">
                    <i class="fas fa-info-circle"></i> Biaya admin sebesar Rp 2.500 akan ditambahkan untuk setiap transaksi
                </div>
            </section>
        </div>
        
        <div id="paymentDetails" style="display: none;">
            <h3 style="text-align: center; margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-shopping-cart"></i> Rincian Pembayaran
            </h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="jumlahTagihan">Jumlah Tagihan:</label>
                    <input type="number" id="jumlahTagihan" placeholder="Contoh: 500000" min="0">
                </div>
                
                <div class="form-group">
                    <label for="biayaAdmin">Biaya Admin:</label>
                    <input type="text" id="biayaAdmin" value="Rp 2.500" readonly>
                </div>
            </div>
            
            <div class="form-group">
                <label for="totalBayar">Total Pembayaran:</label>
                <input type="text" id="totalBayar" value="Rp 0" style="font-size: 20px; font-weight: bold; color: var(--accent);" readonly>
            </div>
            
            <button class="success" onclick="prosesPembayaran()">
                <i class="fas fa-check-circle"></i> Konfirmasi Pembayaran
            </button>
        </div>
        
        <div class="receipt-container" id="receiptContainer">
            <div class="receipt" id="receiptContent">
                <!-- Kop Surat Instansi -->
                <div class="company-header">
                    <div class="company-logo">
                        <img src="https://i.ibb.co/6mZqL2t/company-logo.png" alt="Company Logo">
                    </div>
                    <div class="company-name" id="receiptCompanyName">PT. Energi Sejahtera</div>
                    <div class="company-tagline">Melayani dengan Cepat dan Akurat</div>
                    <div class="company-address" id="receiptCompanyAddress">Jl. Industri No. 45, Jakarta Pusat 10110</div>
                    <div class="company-contact">
                        <div><i class="fas fa-phone"></i> (021) 123456</div>
                        <div><i class="fas fa-envelope"></i> info@energisejahtera.com</div>
                    </div>
                </div>
                
                <div class="receipt-title">BUKTI PEMBAYARAN</div>
                <div class="receipt-subtitle">No. Transaksi: <span id="receiptTransactionId">TRX-00000000</span></div>
                
                <div class="receipt-info">
                    <div>
                        <div class="receipt-label">Nama Pelanggan</div>
                        <div class="receipt-value" id="receiptNama">-</div>
                    </div>
                    <div>
                        <div class="receipt-label">No. Pelanggan</div>
                        <div class="receipt-value" id="receiptNoPelanggan">-</div>
                    </div>
                    <div>
                        <div class="receipt-label">Jenis Tagihan</div>
                        <div class="receipt-value" id="receiptJenisTagihan">-</div>
                    </div>
                    <div>
                        <div class="receipt-label">Tanggal Pembayaran</div>
                        <div class="receipt-value" id="receiptTanggal">-</div>
                    </div>
                    <div>
                        <div class="receipt-label">Periode</div>
                        <div class="receipt-value" id="receiptPeriode">-</div>
                    </div>
                    <div>
                        <div class="receipt-label">Metode Pembayaran</div>
                        <div class="receipt-value" id="receiptMetode">-</div>
                    </div>
                </div>
                
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Deskripsi</th>
                            <th>Jumlah</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Tagihan Utama</td>
                            <td id="receiptTagihan">Rp 0</td>
                        </tr>
                        <tr>
                            <td>Biaya Admin</td>
                            <td>Rp 2.500</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="total-section">
                    <div>Total Pembayaran:</div>
                    <div class="total-amount" id="receiptTotal">Rp 0</div>
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <div class="nft-badge">
                        <i class="fas fa-medal"></i> Struk Digital NFT
                    </div>
                    <div id="qrCodeContainer" style="display: inline-block; margin-top: 20px;"></div>
                </div>
                
                <div style="margin-top: 25px; font-size: 14px; color: var(--gray); text-align: center;">
                    <p>Struk ini merupakan bukti pembayaran yang sah dan telah tercatat di blockchain</p>
                    <p>© 2025 Sistem Pembayaran Digital</p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="downloadPdfBtn" class="accent" onclick="downloadReceipt('pdf')">
                    <i class="fas fa-file-pdf"></i> Unduh PDF
                </button>
                
                <button id="downloadPngBtn" class="accent" onclick="downloadReceipt('png')">
                    <i class="fas fa-image"></i> Unduh PNG
                </button>
                
                <button id="downloadJpgBtn" class="accent" onclick="downloadReceipt('jpg')">
                    <i class="fas fa-image"></i> Unduh JPG
                </button>
                
                <button id="sendEmailBtn" class="success" onclick="sendEmail()">
                    <i class="fas fa-paper-plane"></i> Kirim ke Email
                </button>
                
                <button id="mintNFTBtn" class="secondary" onclick="mintNFT()">
                    <i class="fas fa-coins"></i> Mint sebagai NFT
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>© 2025 Sistem Struk Pembayaran NFT | Bukti pembayaran digital yang aman dan terverifikasi di blockchain</p>
            <p style="margin-top: 10px;">Teknologi blockchain menjamin keaslian dan keabadian setiap transaksi</p>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i> <span id="notificationText">Operasi berhasil!</span>
    </div>

    <script>
        // Inisialisasi jsPDF
        const { jsPDF } = window.jspdf;
        
        let transactionData = {};
        const adminFee = 2500;
        
        // Pilih metode pembayaran
        function selectPaymentMethod(method) {
            document.getElementById('metodePembayaran').value = method;
            
            // Reset semua opsi
            const options = document.querySelectorAll('.payment-option');
            options.forEach(option => option.classList.remove('selected'));
            
            // Tandai opsi yang dipilih
            event.currentTarget.classList.add('selected');
            
            // Tampilkan detail pembayaran jika semua data sudah diisi
            validateForm();
        }
        
        // Validasi form
        function validateForm() {
            const nama = document.getElementById('namaPelanggan').value;
            const email = document.getElementById('email').value;
            const noPelanggan = document.getElementById('noPelanggan').value;
            const metode = document.getElementById('metodePembayaran').value;
            
            if (nama && email && noPelanggan && metode) {
                document.getElementById('paymentDetails').style.display = 'block';
                document.getElementById('paymentDetails').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Hitung total pembayaran
        document.getElementById('jumlahTagihan').addEventListener('input', function() {
            const tagihan = parseFloat(this.value) || 0;
            const total = tagihan + adminFee;
            
            document.getElementById('totalBayar').value = formatRupiah(total);
        });
        
        // Proses pembayaran
        function prosesPembayaran() {
            const tagihan = parseFloat(document.getElementById('jumlahTagihan').value) || 0;
            
            if (tagihan <= 0) {
                showNotification('Masukkan jumlah tagihan yang valid');
                return;
            }
            
            // Simpan data transaksi
            transactionData = {
                nama: document.getElementById('namaPelanggan').value,
                email: document.getElementById('email').value,
                noPelanggan: document.getElementById('noPelanggan').value,
                noTelp: document.getElementById('noTelp').value,
                alamat: document.getElementById('alamat').value,
                jenisTagihan: document.querySelector('#jenisTagihan option:checked').textContent,
                metodePembayaran: document.getElementById('metodePembayaran').value,
                periodeAwal: document.getElementById('periodeAwal').value,
                periodeAkhir: document.getElementById('periodeAkhir').value,
                namaInstansi: document.getElementById('namaInstansi').value || 'PT. Energi Sejahtera',
                alamatInstansi: document.getElementById('alamatInstansi').value || 'Jl. Industri No. 45, Jakarta Pusat 10110',
                jumlahTagihan: tagihan,
                biayaAdmin: adminFee,
                totalBayar: tagihan + adminFee,
                transactionId: generateTransactionId(),
                tanggal: new Date().toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                })
            };
            
            // Generate struk
            generateReceipt();
            
            // Tampilkan struk
            document.getElementById('receiptContainer').style.display = 'block';
            document.getElementById('receiptContainer').scrollIntoView({ behavior: 'smooth' });
            
            showNotification('Pembayaran berhasil diproses!');
        }
        
        // Generate struk pembayaran
        function generateReceipt() {
            document.getElementById('receiptNama').textContent = transactionData.nama;
            document.getElementById('receiptNoPelanggan').textContent = transactionData.noPelanggan;
            document.getElementById('receiptJenisTagihan').textContent = transactionData.jenisTagihan;
            document.getElementById('receiptPeriode').textContent = `${formatDate(transactionData.periodeAwal)} - ${formatDate(transactionData.periodeAkhir)}`;
            document.getElementById('receiptTagihan').textContent = formatRupiah(transactionData.jumlahTagihan);
            document.getElementById('receiptTotal').textContent = formatRupiah(transactionData.totalBayar);
            document.getElementById('receiptTransactionId').textContent = transactionData.transactionId;
            document.getElementById('receiptTanggal').textContent = transactionData.tanggal;
            document.getElementById('receiptMetode').textContent = getPaymentMethodName(transactionData.metodePembayaran);
            document.getElementById('receiptCompanyName').textContent = transactionData.namaInstansi;
            document.getElementById('receiptCompanyAddress').textContent = transactionData.alamatInstansi;
            
            // Generate QR Code
            generateQRCode(transactionData.transactionId);
        }
        
        // Generate QR Code
        function generateQRCode(transactionId) {
            const container = document.getElementById('qrCodeContainer');
            container.innerHTML = '<canvas id="qrCanvas"></canvas><p style="font-size: 14px; margin-top: 10px;">Scan untuk verifikasi transaksi</p>';
            
            const canvas = document.getElementById('qrCanvas');
            const qrUrl = `https://blockchain-verify.com/tx/${transactionId}`;
            
            new QRious({
                element: canvas,
                value: qrUrl,
                size: 150,
                background: '#ffffff',
                foreground: '#000000'
            });
        }
        
        // Download struk
        function downloadReceipt(format) {
            if (!transactionData.transactionId) {
                showNotification('Silakan lakukan pembayaran terlebih dahulu');
                return;
            }
            
            const receiptElement = document.getElementById('receiptContent');
            const filename = `struk-pembayaran-${transactionData.transactionId}`;
            
            // Menambahkan class untuk memastikan skala yang tepat saat rendering
            receiptElement.classList.add('receipt-export');
            
            // Opsi untuk html2canvas
            const options = {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false
            };
            
            if (format === 'pdf') {
                // Generate PDF
                html2canvas(receiptElement, options).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 190;
                    const pageHeight = 297;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 10;

                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    // Add additional pages if the content is too long
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(`${filename}.pdf`);
                    showNotification(`Struk PDF "${filename}" berhasil diunduh!`);
                    
                    // Remove class after rendering
                    receiptElement.classList.remove('receipt-export');
                }).catch(error => {
                    console.error('Error generating PDF:', error);
                    showNotification('Gagal mengunduh PDF. Silakan coba lagi.');
                    receiptElement.classList.remove('receipt-export');
                });
            } else {
                // Generate PNG or JPG
                const imageFormat = format === 'jpg' ? 'jpeg' : 'png';
                
                html2canvas(receiptElement, options).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${filename}.${format}`;
                    link.href = canvas.toDataURL(`image/${imageFormat}`);
                    link.click();
                    showNotification(`Struk ${format.toUpperCase()} "${filename}" berhasil diunduh!`);
                    
                    // Remove class after rendering
                    receiptElement.classList.remove('receipt-export');
                }).catch(error => {
                    console.error(`Error generating ${format.toUpperCase()}:`, error);
                    showNotification(`Gagal mengunduh ${format.toUpperCase()}. Silakan coba lagi.`);
                    receiptElement.classList.remove('receipt-export');
                });
            }
        }
        
        // Kirim struk ke email
        function sendEmail() {
            if (!transactionData.transactionId) {
                showNotification('Silakan lakukan pembayaran terlebih dahulu');
                return;
            }
            
            showNotification('Mengirim struk ke email...');
            
            // Kirim request ke API Resend
            const emailData = {
                to: transactionData.email,
                subject: `Bukti Pembayaran - ${transactionData.transactionId}`,
                html: `
                    <p>Yth. ${transactionData.nama},</p>
                    <p>Terima kasih telah melakukan pembayaran. Berikut adalah bukti pembayaran Anda:</p>
                    <p><strong>No. Transaksi:</strong> ${transactionData.transactionId}</p>
                    <p><strong>Jumlah:</strong> ${formatRupiah(transactionData.totalBayar)}</p>
                    <p><strong>Tanggal:</strong> ${transactionData.tanggal}</p>
                    <p>Bukti pembayaran lengkap dalam bentuk PDF dapat diunduh melalui link berikut:</p>
                    <p><a href="https://example.com/receipts/${transactionData.transactionId}.pdf">Unduh Bukti Pembayaran</a></p>
                    <p>Hormat kami,</p>
                    <p>${transactionData.namaInstansi}</p>
                `
            };
            
            // Kirim ke webhook Resend
            fetch('https://weueopblwiliyjqaaqvb.supabase.co/functions/v1/resendme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(emailData)
            })
            .then(response => {
                if (response.ok) {
                    showNotification('Struk berhasil dikirim ke email!');
                } else {
                    showNotification('Gagal mengirim email. Silakan coba lagi.');
                }
            })
            .catch(error => {
                console.error('Error sending email:', error);
                showNotification('Terjadi kesalahan saat mengirim email.');
            });
        }
        
        // Mint sebagai NFT
        function mintNFT() {
            if (!transactionData.transactionId) {
                showNotification('Silakan lakukan pembayaran terlebih dahulu');
                return;
            }
            
            // Tampilkan loading state
            const mintButton = document.getElementById('mintNFTBtn');
            const originalText = mintButton.innerHTML;
            mintButton.classList.add('btn-loading');
            mintButton.disabled = true;
            
            showNotification('Minting struk sebagai NFT...');
            
            // Data yang akan dikirim ke webhook NFT
            const nftData = {
                transactionId: transactionData.transactionId,
                customerName: transactionData.nama,
                customerEmail: transactionData.email,
                amount: transactionData.totalBayar,
                date: transactionData.tanggal,
                receiptData: transactionData
            };
            
            // Kirim data ke webhook NFT
            fetch('https://weueopblwiliyjqaaqvb.supabase.co/functions/v1/nft-mint-webhook', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(nftData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Network response was not ok.');
            })
            .then(data => {
                showNotification('Struk NFT berhasil dibuat!');
                document.querySelector('.nft-badge').innerHTML = 
                    '<i class="fas fa-check-circle"></i> Struk Digital NFT (Terverifikasi di Blockchain)';
                document.querySelector('.nft-badge').style.background = 'linear-gradient(135deg, #00b09b, #96c93d)';
                
                // Kembalikan tampilan tombol
                mintButton.classList.remove('btn-loading');
                mintButton.innerHTML = originalText;
                mintButton.disabled = false;
            })
            .catch(error => {
                console.error('Error minting NFT:', error);
                showNotification('Gagal membuat NFT. Silakan coba lagi.');
                
                // Kembalikan tampilan tombol
                mintButton.classList.remove('btn-loading');
                mintButton.innerHTML = originalText;
                mintButton.disabled = false;
            });
        }
        
        // Helper functions
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID');
        }
        
        function generateTransactionId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let id = 'TRX-';
            for (let i = 0; i < 8; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return id;
        }
        
        function showNotification(message) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function getPaymentMethodName(method) {
            switch(method) {
                case 'bank': return 'Transfer Bank';
                case 'ewallet': return 'E-Wallet';
                case 'kartu': return 'Kartu Debit';
                case 'cash': return 'Tunai';
                default: return '-';
            }
        }
        
        // Inisialisasi data contoh untuk demo
        document.addEventListener('DOMContentLoaded', function() {
            // Set tanggal default
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setMonth(today.getMonth() - 1);
            
            document.getElementById('periodeAwal').valueAsDate = lastMonth;
            document.getElementById('periodeAkhir').valueAsDate = today;
            
            // Isi data contoh
            document.getElementById('namaPelanggan').value = 'Budi Santoso';
            document.getElementById('email').value = 'budi@example.com';
            document.getElementById('noPelanggan').value = 'PLG-2023001';
            document.getElementById('noTelp').value = '081234567890';
            document.getElementById('alamat').value = 'Jl. Sudirman No. 123, Jakarta Selatan';
            document.getElementById('jumlahTagihan').value = '575000';
            document.getElementById('namaInstansi').value = 'PT. Energi Sejahtera';
            document.getElementById('alamatInstansi').value = 'Jl. Industri No. 45, Jakarta Pusat 10110';
            document.getElementById('telpInstansi').value = '(021) 123456';
            document.getElementById('emailInstansi').value = 'info@energisejahtera.com';
            
            // Hitung total bayar
            document.getElementById('totalBayar').value = formatRupiah(575000 + adminFee);
        });
    </script>
</body>
</html>